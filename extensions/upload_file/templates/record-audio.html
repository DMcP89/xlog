<script>
 (async function() {
     function uploadFile(file) {
         var data = new FormData()
         data.append('file', file)
         data.append('csrf', document.querySelector('input[name=csrf]').value);
         var params = {method: 'POST', body: data};

         fetch('{{ .action }}', params).then(resp => resp.text()).then(text => {
             document.location.reload();
         });
     }

     let params = {audio: true}
     let stream = await navigator.mediaDevices.getUserMedia(params);
     let extension = "opus"
     let mimetype = "audio/webm; codecs=opus"
     let options = { mimeType: mimetype };
     let recorder = new MediaRecorder(stream, options);
     recorder.ondataavailable = (event) => {
         if (event.data.size > 0)
             uploadFile(new File([event.data], 'recording.'+extension, {type: mimetype}));
     }
     recorder.start();
 })()
</script>
